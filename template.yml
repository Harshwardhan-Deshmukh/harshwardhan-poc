parameters:
- name: sdfx_version
  type: string 
- name: node_version
  type: string 
- name: secure_file_variable_name
  type: string 
- name: username
  type: string 
- name: instance_url
  type: string 
- name: client_id
  type: string 
- name: environment_name
  type: string 

steps:
  - task: UseNode@1
    displayName: 'Use Node.js ${{ parameters.node_version }}'
    inputs:
      version: '${{ parameters.node_version }}'

  - bash: |
      echo "Installing sdfx cli in ${{ parameters.sdfx_version }} version"
      npm install sfdx-cli@${{ parameters.sdfx_version }} --global
    displayName: Install Salesforce CLI

  - task: DownloadSecureFile@1
    name: caCertificate
    displayName: 'Download CA certificate'
    inputs:
      secureFile: ${{ parameters.secure_file_variable_name }}

  - script: |
      echo Installing $(caCertificate.secureFilePath) to the trusted CA directory...
      sudo chown root:root $(caCertificate.secureFilePath)
      sudo chmod a+r $(caCertificate.secureFilePath)
      sudo ln -s -t /etc/ssl/certs/ $(caCertificate.secureFilePath)
    displayName: Prepare secure file

  - bash:
      sfdx force:auth:jwt:grant --clientid "${{ parameters.client_id }}" --jwtkeyfile $(Agent.TempDirectory)/${{ parameters.secure_file_variable_name }} --username "${{ parameters.username }}" --instanceurl "${{ parameters.instance_url }}" -a ${{ parameters.environment_name }}
    displayName: Authorize to salesforce org devint
