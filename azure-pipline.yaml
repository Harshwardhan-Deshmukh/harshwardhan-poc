trigger:
  - master

pool:
  vmImage: "windows-latest"

stages:
  - stage: first_stage
    jobs:
      - job: FIRST_JOB
        steps:
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                # Write your commands here
                echo "Checking complete"
          
          - template: "./template.yml"
          
          - task: Bash@3
            inputs:
              targetType: 'inline'
              script: |
                echo 'Hello World'
          
          - task: Bash@3
            displayName: First Check within same JOB
            inputs:
              targetType: 'inline'
              script: |
                echo $(PythonScript.myVar) 

      - job: Check  
        dependsOn: FIRST_JOB  
        variables: 
            myVarFromJobA: $[ dependencies.FIRST_JOB.outputs['PythonScript.myVar'] ] 
        steps:
        - task: Bash@3
          displayName: Second Check from different JOB
          inputs:
            targetType: 'inline'
            script: |
              echo $(myVarFromJobA) 

      # - job: waitForValidation
      #   condition: and(succeeded(), eq(variables['myVarFromJobA'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      #   variables:
      #     - name : harsh
      #       value : hardeshm@publicisgroupe.net
      #     - name: myVarFromJobA
      #       value: $[ dependencies.FIRST_JOB.outputs['PythonScript.myVar'] ] 
      #   displayName: Wait for external validation
      #   dependsOn: FIRST_JOB  
      #   pool: server
      #   timeoutInMinutes: 4320 # job times out in 3 days
      #   steps:
      #   - task: ManualValidation@0
      #     timeoutInMinutes: 1440 # task times out in 1 day
      #     inputs:
      #       notifyUsers: | 
      #         [Demo Project]\Contributors
      #       instructions: 'Please validate the build configuration and resume'
      #       onTimeout: 'resume'  
  
  - stage: Variable_Check
    # condition: and(succeeded(), eq(variables['myVar'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    dependsOn: first_stage
    displayName: Variable Checking stage
    variables:
      - name: checker
        value : $[ stageDependencies.first_stage.FIRST_JOB.outputs['PythonScript.MyVar'] ]
    jobs:
    - job:
      steps:
        - bash: echo $(checker) 
          name: varCheck

  - stage: Manual_Approval
    dependsOn: Variable_Check
    # condition: and(succeeded(), eq(variables['myVar'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
    variables:
      - name: checker
        value : $[ stageDependencies.first_stage.FIRST_JOB.outputs['PythonScript.MyVar'] ]
    jobs:
    - bash: echo $(checker) 
      name: varCheck

    - deployment: A
      condition: and(succeeded(), eq(variables['myVar'], 'true'), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      displayName: Check Approval
      environment: 'dev'
      strategy:                  
        runOnce:
          deploy:
            steps:
            - bash: echo $(checker)
              name: varCheck

  - stage: Second_Stage
    dependsOn: Manual_Approval
    jobs:
      - job: Check  
        steps:
        - task: Bash@3
          displayName: Next Stage Skip Test
          inputs:
            targetType: 'inline'
            script: |
              echo "Hello World!"
              echo $(Build.SourceBranch)

